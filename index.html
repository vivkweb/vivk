<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>موقع AI مبدئي — دردشة ذكية | Vivk</title>
  <meta name="description" content="واجهة ذكاء اصطناعي مبدئية، دردشة، حفظ المحادثات، تصدير واستيراد، متعدد اللغات."/>
  <!-- Tailwind CDN (for static single-file demo) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* إضافات سريعة */
    :root{
      --glass-bg: rgba(255,255,255,0.06);
      --glass-border: rgba(255,255,255,0.08);
      --accent: linear-gradient(90deg,#7c3aed,#06b6d4);
    }
    /* video shadow effect */
    .video-shadow {
      position: absolute;
      inset: 0;
      z-index: -1;
      filter: blur(28px) saturate(120%) opacity(0.45);
      transform: scale(1.06);
      pointer-events: none;
      mix-blend-mode: screen;
    }
    /* dark glass card */
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(8px) saturate(120%);
    }
    /* language direction adjustments */
    [lang="en"] { direction: ltr; }
    [lang="es"] { direction: ltr; }

    /* animation for message pop */
    @keyframes pop {
      from { transform: translateY(8px) scale(0.98); opacity: 0;}
      to { transform: translateY(0) scale(1); opacity: 1;}
    }
    .pop { animation: pop .22s ease-out both; }
    /* floating gradient accent */
    .floating-accent {
      position: absolute;
      width: 380px;
      height: 380px;
      border-radius: 48%;
      filter: blur(60px);
      opacity: .55;
      transform: translate(-20%, -10%) rotate(-15deg);
      z-index: -2;
      background: radial-gradient(circle at 30% 30%, rgba(124,58,237,0.65), transparent 20%),
                  radial-gradient(circle at 70% 70%, rgba(6,182,212,0.45), transparent 20%);
    }

    /* responsive tweaks */
    @media (max-width: 820px) {
      .floating-accent { width: 260px; height: 260px; filter: blur(40px); }
    }
  </style>
</head>
<body class="min-h-screen bg-[#05060a] text-slate-100 antialiased">
  <!-- floating accent & background video -->
  <div class="relative overflow-hidden">
    <div class="floating-accent"></div>

    <!-- optional decorative video (local or remote). For offline use, browser will ignore if not found -->
    <video autoplay muted loop playsinline class="absolute inset-0 w-full h-full object-cover opacity-20">
      <source src="https://cdn.jsdelivr.net/gh/lichunhui/video-assets@main/subtle-wave.mp4" type="video/mp4">
      <!-- fallback: animated gradient via CSS -->
    </video>
    <!-- soft shadow layer based on video -->
    <div class="video-shadow" aria-hidden="true" style="background: radial-gradient(40% 40% at 20% 30%, rgba(7,89,133,0.6), transparent 10%), radial-gradient(30% 30% at 80% 70%, rgba(124,58,237,0.55), transparent 10%);"></div>

    <!-- Header -->
    <header class="max-w-6xl mx-auto p-6 flex items-center justify-between gap-4">
      <div class="flex items-center gap-4">
        <div class="p-2 rounded-2xl glass flex items-center gap-3">
          <div class="w-12 h-12 rounded-lg flex items-center justify-center bg-gradient-to-br from-purple-600 to-cyan-400 shadow-lg">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" class="text-white">
              <path d="M12 2v4" stroke="white" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="14" r="6" stroke="white" stroke-width="1.4"/>
            </svg>
          </div>
          <div class="text-right leading-tight">
            <div class="text-sm font-semibold">Vivk AI</div>
            <div class="text-xs text-slate-300">موقع ذكاء اصطناعي مبدئي</div>
          </div>
        </div>

        <nav class="hidden md:flex gap-3 items-center text-sm text-slate-300">
          <button id="featuresBtn" class="px-3 py-2 rounded-md hover:bg-white/5">الخصائص</button>
          <button id="examplesBtn" class="px-3 py-2 rounded-md hover:bg-white/5">نماذج</button>
          <a href="#chat" class="px-3 py-2 rounded-md hover:bg-white/5">الدردشة</a>
        </nav>
      </div>

      <div class="flex items-center gap-3">
        <!-- Language selector -->
        <div class="glass rounded-lg px-2 py-1 flex items-center gap-2">
          <select id="langSelect" aria-label="اختيار اللغة" class="bg-transparent outline-none text-sm text-slate-100">
            <option value="ar" selected>العربية</option>
            <option value="en">English</option>
            <option value="es">Español</option>
          </select>
        </div>

        <!-- API key input dropdown -->
        <div id="apiBox" class="glass rounded-lg px-3 py-1 flex items-center gap-2">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="text-slate-200"><path d="M12 11v2" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/><path d="M6 3h12l2 4v10a2 2 0 0 1-2 2H6A2 2 0 0 1 4 17V7l2-4z" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input id="apiKey" placeholder="للاستخدام الحقيقي: ضع مفتاح OpenAI هنا (اختياري)" class="bg-transparent outline-none text-xs w-52" />
          <button id="saveKeyBtn" class="text-xs px-2 py-1 rounded-md bg-white/5">حفظ</button>
        </div>

        <a id="exportBtn" class="glass rounded-lg px-3 py-2 text-xs hover:bg-white/5 cursor-pointer">تصدير المحادثة</a>
      </div>
    </header>

    <!-- Main content -->
    <main class="max-w-6xl mx-auto p-6 grid grid-cols-12 gap-6">
      <!-- Left column: Intro + features -->
      <section class="col-span-12 lg:col-span-5">
        <div class="glass rounded-2xl p-6 shadow-xl">
          <h1 class="text-2xl lg:text-3xl font-bold pop">واجهتك الذكية — بسيطة، سريعة، واحترافية</h1>
          <p id="tagline" class="text-sm text-slate-300 mt-2">دردشة AI، حفظ تلقائي، تعدد لغات، وميزات تصدير واستيراد. جرب الآن — سواء كمحاكاة محلية أو متصل بمفتاح API خاص بك.</p>

          <div class="mt-5 grid gap-3">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-gradient-to-br from-purple-600 to-cyan-400 flex items-center justify-center">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2v6" stroke="white" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 14v8" stroke="white" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </div>
              <div>
                <div class="font-semibold">حفظ تلقائي</div>
                <div class="text-xs text-slate-300">المحادثات تُحفظ محلياً (localStorage) ويمكن تصديرها.</div>
              </div>
            </div>

            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-gradient-to-br from-rose-500 to-orange-400 flex items-center justify-center">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 4v16" stroke="white" stroke-width="1.4" stroke-linecap="round"/></svg>
              </div>
              <div>
                <div class="font-semibold">تعدد لغات</div>
                <div class="text-xs text-slate-300">واجهة بالعربية/English/Español — دون إعادة تحميل الصفحة.</div>
              </div>
            </div>

            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-gradient-to-br from-emerald-400 to-sky-500 flex items-center justify-center">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 12h18" stroke="white" stroke-width="1.4" stroke-linecap="round"/></svg>
              </div>
              <div>
                <div class="font-semibold">نماذج جاهزة</div>
                <div class="text-xs text-slate-300">أسئلة نموذجية جاهزة لبدء المحادثة أو تجربة قدرات الموقع.</div>
              </div>
            </div>

          </div>

          <!-- Quick actions -->
          <div class="mt-6 flex flex-wrap gap-3">
            <button id="newConv" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-cyan-400 font-semibold shadow">محادثة جديدة</button>
            <button id="importBtn" class="px-4 py-2 rounded-lg bg-white/5">استيراد محادثة</button>
            <button id="clearAll" class="px-4 py-2 rounded-lg bg-white/5 text-xs">مسح الحفظ</button>
          </div>

          <!-- examples -->
          <div class="mt-5 border-t border-white/5 pt-4">
            <h3 class="text-sm font-semibold">نماذج سريعة</h3>
            <div class="mt-3 grid gap-2">
              <button class="exampleBtn text-sm text-left p-2 rounded-md hover:bg-white/3" data-prompt="اكتب لي نبذة احترافية قصيرة عن مطور ويب عربي.">نبذة احترافية عن مطور ويب</button>
              <button class="exampleBtn text-sm text-left p-2 rounded-md hover:bg-white/3" data-prompt="ترجم هذه الجملة إلى الإنجليزية: كيف يمكنني البدء في مشروع ذكاء اصطناعي؟">ترجمة للجملة</button>
              <button class="exampleBtn text-sm text-left p-2 rounded-md hover:bg-white/3" data-prompt="عطيني خمس أفكار لمحتوى فيديو قصير عن الذكاء الاصطناعي">أفكار لفيديو قصير</button>
            </div>
          </div>

        </div>

        <!-- small footer info -->
        <div class="mt-4 text-xs text-slate-400">
          <div>ملاحظة: يمكنك لصق مفتاح OpenAI لاستخدام الذكاء الاصطناعي الحقيقي (اختياري). المحاكاة تعمل بدون اتصال.</div>
        </div>
      </section>

      <!-- Right column: Chat -->
      <section id="chat" class="col-span-12 lg:col-span-7">
        <div class="glass rounded-2xl p-4 h-[74vh] flex flex-col">
          <!-- header -->
          <div class="flex items-center justify-between gap-3 pb-3 border-b border-white/5">
            <div>
              <div class="text-sm font-semibold">مساعد الذكاء الاصطناعي</div>
              <div id="subline" class="text-xs text-slate-300">جاهز للمحادثة — اكتب رسالتك أدناه.</div>
            </div>
            <div class="flex items-center gap-2">
              <button id="pinBtn" class="text-xs px-3 py-1 rounded-md bg-white/5">تبديل الوضع</button>
            </div>
          </div>

          <!-- messages -->
          <div id="messages" class="flex-1 overflow-auto my-3 p-3 space-y-3">
            <!-- dynamic messages will appear here -->
          </div>

          <!-- composer -->
          <div class="pt-3 border-t border-white/5">
            <div class="flex gap-2 items-center">
              <textarea id="prompt" rows="2" placeholder="اكتب رسالتك هنا..." class="flex-1 resize-none bg-transparent outline-none placeholder:text-slate-400 p-3 text-sm rounded-lg glass"></textarea>
              <button id="sendBtn" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-cyan-400 font-semibold">أرسل</button>
            </div>

            <div class="mt-2 flex items-center justify-between text-xs text-slate-400">
              <div>النتائج محلية / يمكن تفعيل API</div>
              <div class="flex gap-2">
                <button id="saveConv" class="px-2 py-1 rounded bg-white/5">حفظ</button>
                <button id="copyAll" class="px-2 py-1 rounded bg-white/5">نسخ</button>
              </div>
            </div>
          </div>
        </div>

        <!-- instructions / hidden file input -->
        <input id="fileInput" type="file" accept="application/json" class="hidden" />
      </section>
    </main>
  </div>

  <!-- Templates & Scripts -->
  <template id="msgTpl">
    <div class="pop flex gap-3 items-start">
      <div class="w-10 h-10 rounded-lg bg-white/5 flex items-center justify-center shrink-0">AI</div>
      <div class="flex-1">
        <div class="text-xs text-slate-400 mb-1">الرد</div>
        <div class="bg-white/3 p-3 rounded-lg text-sm leading-relaxed whitespace-pre-wrap"></div>
        <div class="mt-2 flex gap-2">
          <button class="copyBtn text-xs px-2 py-1 rounded bg-white/5">نسخ</button>
          <button class="saveBtn text-xs px-2 py-1 rounded bg-white/5">أضف للمفضلة</button>
        </div>
      </div>
    </div>
  </template>

  <script>
    /* ======= نصوص الواجهة للغات ======= */
    const i18n = {
      ar: {
        tagline: "دردشة AI، حفظ تلقائي، تعدد لغات، وميزات تصدير واستيراد. جرب الآن — سواء كمحاكاة محلية أو متصل بمفتاح API خاص بك.",
        ready: "جاهز للمحادثة — اكتب رسالتك أدناه.",
        send: "أرسل",
      },
      en: {
        tagline: "AI chat, autosave, multilingual, export/import. Try now — local simulation or connect with your API key.",
        ready: "Ready to chat — type your message below.",
        send: "Send",
      },
      es: {
        tagline: "Chat IA, guardado automático, multilenguaje, exportar/importar. Prueba ahora — simulación local o conecta con tu clave API.",
        ready: "Listo para chatear — escribe tu mensaje abajo.",
        send: "Enviar",
      }
    };

    /* ======= عناصر DOM ======= */
    const langSelect = document.getElementById('langSelect');
    const tagline = document.getElementById('tagline');
    const subline = document.getElementById('subline');
    const promptEl = document.getElementById('prompt');
    const sendBtn = document.getElementById('sendBtn');
    const messagesWrap = document.getElementById('messages');
    const msgTpl = document.getElementById('msgTpl');
    const newConv = document.getElementById('newConv');
    const exportBtn = document.getElementById('exportBtn');
    const saveKeyBtn = document.getElementById('saveKeyBtn');
    const apiKeyInput = document.getElementById('apiKey');
    const importBtn = document.getElementById('importBtn');
    const fileInput = document.getElementById('fileInput');
    const clearAll = document.getElementById('clearAll');
    const examples = document.querySelectorAll('.exampleBtn');
    const copyAll = document.getElementById('copyAll');
    const saveConvBtn = document.getElementById('saveConv');

    /* ======= حالة المحادثة ======= */
    let state = {
      lang: localStorage.getItem('vivk.lang') || 'ar',
      apiKey: localStorage.getItem('vivk.apikey') || '',
      convs: JSON.parse(localStorage.getItem('vivk.convs') || '[]'),
      current: { id: Date.now(), messages: [] }
    };

    // تهيئة الواجهة
    function applyLang() {
      const L = state.lang;
      tagline.textContent = i18n[L].tagline;
      subline.textContent = i18n[L].ready;
      sendBtn.textContent = i18n[L].send;
      // set dir & lang attributes on body for proper alignment
      document.documentElement.lang = L === 'ar' ? 'ar' : (L === 'en' ? 'en' : 'es');
      document.documentElement.dir = L === 'ar' ? 'rtl' : 'ltr';
      // small visual tweak: align chat
      messagesWrap.scrollTop = messagesWrap.scrollHeight;
    }

    langSelect.value = state.lang;
    applyLang();

    // حفظ مفتاح API إن وُجد
    saveKeyBtn.addEventListener('click', () => {
      state.apiKey = apiKeyInput.value.trim();
      localStorage.setItem('vivk.apikey', state.apiKey);
      alert('تم حفظ مفتاح الـ API محليًا (إن وضعته).');
    });

    // إرسال رسالة (محاكاة محلية أو عبر API إذا وُجد)
    sendBtn.addEventListener('click', handleSend);
    promptEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    function handleSend() {
      const text = promptEl.value.trim();
      if (!text) return;
      appendUserMessage(text);
      promptEl.value = '';
      // استدعاء المولد: إذا وُجد API key نحاول إرسالها (مؤقت/اختياري)، وإلا نستخدم محاكاة ذكية
      if (state.apiKey) {
        callOpenAI(text).then(res => {
          appendAIMessage(res);
        }).catch(err=>{
          appendAIMessage('حدث خطأ أثناء الاتصال بالـ API. الرد محلي بدلاً من ذلك.\n\n' + mockResponse(text));
        });
      } else {
        const simulated = mockResponse(text);
        // محاكاة تأخير
        appendAIMessage(simulated);
      }
    }

    function appendUserMessage(text) {
      const el = document.createElement('div');
      el.className = 'flex gap-3 items-start justify-end pop';
      el.innerHTML = `
        <div class="flex-1 text-right">
          <div class="text-xs text-slate-400 mb-1">أنت</div>
          <div class="bg-white/6 p-3 rounded-lg text-sm leading-relaxed whitespace-pre-wrap">${escapeHtml(text)}</div>
        </div>
        <div class="w-10 h-10 rounded-lg bg-white/5 flex items-center justify-center shrink-0">أ</div>
      `;
      messagesWrap.appendChild(el);
      state.current.messages.push({ role: 'user', content: text, ts: Date.now() });
      autosaveState();
      messagesWrap.scrollTop = messagesWrap.scrollHeight;
    }

    function appendAIMessage(text) {
      const tpl = msgTpl.content.cloneNode(true);
      const container = tpl.querySelector('div');
      const bubble = tpl.querySelector('div div[style], div > div > div'); // safe selector
      const contentDiv = tpl.querySelector('div div.bg-white\\\/3');
      contentDiv.textContent = text;
      // attach copy and save handlers
      tpl.querySelector('.copyBtn').addEventListener('click', ()=>navigator.clipboard.writeText(text));
      tpl.querySelector('.saveBtn').addEventListener('click', ()=>{
        alert('أضيفت إلى المفضلة (محلياً).');
      });
      messagesWrap.appendChild(tpl);
      state.current.messages.push({ role: 'assistant', content: text, ts: Date.now() });
      autosaveState();
      messagesWrap.scrollTop = messagesWrap.scrollHeight;
    }

    // نسخ كل المحادثة
    copyAll.addEventListener('click', ()=>{
      const txt = state.current.messages.map(m=>`${m.role === 'user' ? 'أنت' : 'AI'}: ${m.content}`).join('\n\n');
      navigator.clipboard.writeText(txt);
      alert('تم نسخ المحادثة.');
    });

    // حفظ / تصدير المحادثة
    exportBtn.addEventListener('click', () => {
      const data = {
        id: state.current.id,
        created: Date.now(),
        messages: state.current.messages
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `conversation-${state.current.id}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // استيراد محادثة
    importBtn.addEventListener('click', ()=>fileInput.click());
    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files[0];
      if (!f) return;
      try {
        const txt = await f.text();
        const obj = JSON.parse(txt);
        if (obj && obj.messages) {
          state.current = obj;
          renderCurrent();
          autosaveState();
          alert('تم استيراد المحادثة.');
        } else alert('الملف لا يبدو كملف محادثة صالح.');
      } catch (err) {
        alert('خطأ بقراءة الملف.');
      }
    });

    // مسح الحفظ الكلي
    clearAll.addEventListener('click', ()=>{
      if (!confirm('سيتم مسح كل المحادثات المحفوظة محلياً. هل تريد المتابعة؟')) return;
      localStorage.removeItem('vivk.convs');
      state.convs = [];
      state.current = { id: Date.now(), messages: [] };
      renderCurrent();
    });

    // محادثة جديدة
    newConv.addEventListener('click', ()=>{
      state.current = { id: Date.now(), created: Date.now(), messages: [] };
      renderCurrent();
    });

    // حفظ يدوي
    saveConvBtn.addEventListener('click', ()=>{
      state.convs.push(state.current);
      localStorage.setItem('vivk.convs', JSON.stringify(state.convs));
      alert('تم حفظ المحادثة في التخزين المحلي.');
    });

    // أمثلة جاهزة
    examples.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const p = btn.dataset.prompt;
        promptEl.value = p;
        promptEl.focus();
      });
    });

    // تغيير اللغة
    langSelect.addEventListener('change', (e)=> {
      state.lang = e.target.value;
      localStorage.setItem('vivk.lang', state.lang);
      applyLang();
    });

    // حفظ تلقائي to localStorage
    function autosaveState() {
      localStorage.setItem('vivk.current', JSON.stringify(state.current));
      // keep small history array too
      localStorage.setItem('vivk.convs', JSON.stringify(state.convs));
    }

    // render current conversation to DOM
    function renderCurrent() {
      messagesWrap.innerHTML = '';
      if (!state.current || !state.current.messages) return;
      state.current.messages.forEach(m=>{
        if (m.role === 'user') {
          const el = document.createElement('div');
          el.className = 'flex gap-3 items-start justify-end pop';
          el.innerHTML = `
            <div class="flex-1 text-right">
              <div class="text-xs text-slate-400 mb-1">أنت</div>
              <div class="bg-white/6 p-3 rounded-lg text-sm leading-relaxed whitespace-pre-wrap">${escapeHtml(m.content)}</div>
            </div>
            <div class="w-10 h-10 rounded-lg bg-white/5 flex items-center justify-center shrink-0">أ</div>
          `;
          messagesWrap.appendChild(el);
        } else {
          const tpl = msgTpl.content.cloneNode(true);
          tpl.querySelector('div div.bg-white\\/3').textContent = m.content;
          tpl.querySelector('.copyBtn').addEventListener('click', ()=>navigator.clipboard.writeText(m.content));
          messagesWrap.appendChild(tpl);
        }
      });
      messagesWrap.scrollTop = messagesWrap.scrollHeight;
    }

    // small helper: escape HTML
    function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // mock response generator (local, creative)
    function mockResponse(userText){
      // make simple heuristics
      const t = userText.toLowerCase();
      if (t.includes('ترجم') || t.includes('translate')) {
        return "هذا مثال للترجمة (محاكاة):\n\nالإنجليزية: \"How can I start an AI project?\"\n\nترجمة مقترحة: \"كيف أبدأ مشروعًا في الذكاء الاصطناعي؟\"";
      }
      if (t.includes('فكرة') || t.includes('idea') || t.includes('أفكار')) {
        return "أفكار سريعة:\n1) فيديو قصير يشرح نموذج بسيط للـ AI.\n2) سلسلة دروس خطوة بخطوة.\n3) حالات استخدام في الواقع (مثال: تصنيف الصور).\n4) مقارنة بين المكتبات الشائعة.\n5) مشروع مبسط تفاعلي يشرح المفاهيم.";
      }
      if (t.length < 40) {
        return "رد مبدئي (محاكاة): شكرًا على سؤالك! هل تود أن أقدّم شرحًا تفصيليًا أم ملخّصًا سريعًا؟";
      }
      // else produce a helpful-sounding reply
      return "إجابة مُحاكاة ذكية:\n\n" + summarizeText(userText);
    }

    // smart-ish summarizer (local)
    function summarizeText(s) {
      // trivial split into sentences and keep first 2 meaningful ones
      const parts = s.split(/[.!؟\n]/).map(p=>p.trim()).filter(Boolean);
      if (parts.length <= 2) return parts.join(' - ');
      return parts.slice(0,2).join('. ') + '...';
    }

    /* ======= Optional: call OpenAI (if apiKey provided) =======
       This function demonstrates how to call OpenAI's chat completions.
       NOTE: For security, calling OpenAI directly from client exposes the key to the user agent.
       For real deployments, proxy requests through your server.
    */
    async function callOpenAI(userText) {
      // basic example for Chat Completions (OpenAI). Adjust endpoint and model as needed.
      const key = state.apiKey;
      if (!key) throw new Error('No API key');
      // Example: using OpenAI Chat Completions API (v1/chat/completions)
      // You may need to adjust to the current provider's spec.
      const res = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + key },
        body: JSON.stringify({
          model: "gpt-4o-mini", // example; change to available model
          messages: [{ role: 'user', content: userText }],
          temperature: 0.7,
          max_tokens: 600
        })
      });
      if (!res.ok) {
        const errtxt = await res.text();
        throw new Error('OpenAI error: ' + errtxt);
      }
      const data = await res.json();
      // this parsing assumes OpenAI's chat completion structure
      const out = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || JSON.stringify(data);
      return out;
    }

    // small init: load saved current conversation if exists
    (function initFromStorage(){
      const saved = localStorage.getItem('vivk.current');
      if (saved) {
        try {
          const obj = JSON.parse(saved);
          if (obj && obj.messages) state.current = obj;
        } catch(e){}
      }
      renderCurrent();
    })();

    // helper: simple escape for textareas when rendering plain text (already used above)
  </script>
</body>
</html>